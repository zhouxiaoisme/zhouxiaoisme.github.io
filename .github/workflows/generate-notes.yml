name: è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰å­ç›®å½•ç¬”è®°åˆ—è¡¨
on:
  push:
    paths:
      - '**/*.html'  # ç›‘å¬æ‰€æœ‰HTMLæ–‡ä»¶ï¼ˆåŒ…æ‹¬æ–°å¢/ä¿®æ”¹/åˆ é™¤ï¼‰
      - '.github/workflows/generate-notes.yml' # é…ç½®æ–‡ä»¶å˜æ›´ä¹Ÿè§¦å‘
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘å…œåº•
jobs:
  generate-notes:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è‡ªåŠ¨æ‰«æå¹¶ç”Ÿæˆæ‰€æœ‰å­ç›®å½•ç¬”è®°åˆ—è¡¨
        run: |
          # å®šä¹‰éœ€è¦æ’é™¤çš„ç›®å½•
          EXCLUDE_DIRS=(".github" "node_modules" "assets" "images" ".git")
          
          # è·å–æ ¹ç›®å½•ä¸‹æ‰€æœ‰ä¸€çº§å­ç›®å½•
          ALL_DIRS=$(find . -maxdepth 1 -type d | sed 's|^\./||' | grep -v '^\.$')
          
          # éå†æ¯ä¸ªç›®å½•
          for dir in $ALL_DIRS; do
            # è·³è¿‡æ’é™¤ç›®å½•
            if [[ " ${EXCLUDE_DIRS[@]} " =~ " $dir " ]]; then
              echo "è·³è¿‡æ’é™¤ç›®å½•ï¼š$dir"
              continue
            fi
            
            echo "å¼€å§‹å¤„ç†ç›®å½•ï¼š$dir"
            # ç›®å½•æ— æ³•è¿›å…¥åˆ™è·³è¿‡
            cd "$dir" || continue
            
            # ç”Ÿæˆä¸ªæ€§åŒ–æ ‡é¢˜
            DIR_NAME_CLEAN=$(echo "$dir" | sed 's/Course//g')
            DIR_TITLE=$(echo "$DIR_NAME_CLEAN" | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)} 1')
            PAGE_TITLE="${DIR_TITLE}å­¦ä¹ ç¬”è®°"
            SUB_TITLE="ä»åº•å±‚é€»è¾‘æ‹†è§£${PAGE_TITLE}ï¼Œè¾ƒçœŸæ¯ä¸€ä¸ªçŸ¥è¯†ç‚¹"
            
            # å…³é”®ä¿®å¤1ï¼šæ›¿æ¢Emojiä¸ºHTMLå®ä½“/çº¯æ–‡æœ¬ï¼Œé¿å…ç¼–ç ä¹±ç 
            # ä¸å†ä½¿ç”¨åŸç”ŸEmojiï¼Œæ”¹ç”¨HTMLå®ä½“æˆ–æ–‡å­—æè¿°ï¼Œç¡®ä¿å…¼å®¹æ€§
            case $DIR_NAME_CLEAN in
              "python") AVATAR_CONTENT="&#128013;" ;; # ğŸ çš„HTMLå®ä½“
              "ai") AVATAR_CONTENT="&#129302;" ;;     # ğŸ¤– çš„HTMLå®ä½“
              "aigc") AVATAR_CONTENT="&#127912;" ;;   # ğŸ¨ çš„HTMLå®ä½“
              "java") AVATAR_CONTENT="&#9749;" ;;      # â˜• çš„HTMLå®ä½“
              "web") AVATAR_CONTENT="&#127760;" ;;     # ğŸŒ çš„HTMLå®ä½“
              *) AVATAR_CONTENT="&#128218;" ;;         # ğŸ“š çš„HTMLå®ä½“ï¼ˆé»˜è®¤ï¼‰
            esac
            
            # å¼ºåˆ¶æ¸…ç©ºæ—§çš„notes.htmlï¼Œç¡®ä¿å®Œå…¨é‡æ–°ç”Ÿæˆ
            rm -f notes.html
            # é‡æ–°åˆ›å»ºç©ºçš„notes.html
            touch notes.html
            
            # å†™å…¥HTMLå¤´éƒ¨ï¼ˆå…³é”®ä¿®å¤2ï¼šæŒ‡å®šUTF-8ç¼–ç ï¼Œç¡®ä¿ç‰¹æ®Šå­—ç¬¦æ­£å¸¸æ¸²æŸ“ï¼‰
            echo "<!DOCTYPE html>
            <html lang='zh-CN'>
            <head>
                <meta charset='UTF-8'> <!-- å¼ºåˆ¶æŒ‡å®šUTF-8ç¼–ç ï¼Œæ ¸å¿ƒä¿éšœ -->
                <meta http-equiv='Content-Type' content='text/html; charset=utf-8'> <!-- å…¼å®¹æ—§æµè§ˆå™¨ -->
                <meta name='viewport' content='width=device-width, initial-scale=1.0'>
                <title>$PAGE_TITLE | ä¸€ä¸ªæ™®é€šçš„æ€è€ƒè€…</title>
                <style>
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                        font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
                        transition: all 0.3s ease;
                    }
                    body {
                        background: linear-gradient(120deg, #f5f7fa 0%, #e4eaf5 100%);
                        color: #333;
                        line-height: 1.5;
                        padding: 20px;
                        max-width: 1000px;
                        margin: 0 auto;
                        min-height: 100vh;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        charset: utf-8; /* é¢å¤–ä¿éšœç¼–ç ä¸€è‡´æ€§ */
                    }
                    .container {
                        background: rgba(255, 255, 255, 0.95);
                        border-radius: 16px;
                        padding: 40px 60px;
                        box-shadow: 0 8px 24px rgba(149, 157, 165, 0.15);
                        border: 1px solid #e8f4f8;
                    }
                    .header {
                        text-align: center;
                        margin-bottom: 35px;
                    }
                    .avatar {
                        width: 120px;
                        height: 120px;
                        border-radius: 50%;
                        background: linear-gradient(45deg, #4299e1 0%, #38b2ac 100%);
                        margin: 0 auto 20px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 48px;
                        color: white;
                        box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
                    }
                    .avatar:hover {
                        transform: scale(1.05);
                        box-shadow: 0 6px 18px rgba(66, 153, 225, 0.4);
                    }
                    h1 {
                        font-size: 32px;
                        margin-bottom: 8px;
                        background: linear-gradient(90deg, #2d3748, #4a5568);
                        -webkit-background-clip: text;
                        background-clip: text;
                        color: transparent;
                        font-weight: 600;
                    }
                    .subtitle {
                        color: #718096;
                        font-size: 17px;
                        font-weight: 400;
                        font-style: italic;
                    }
                    .notes-section h2 {
                        font-size: 22px;
                        margin-bottom: 15px;
                        background: linear-gradient(90deg, #4299e1, #9f7aea);
                        -webkit-background-clip: text;
                        background-clip: text;
                        color: transparent;
                        border-left: 4px solid #4299e1;
                        padding-left: 12px;
                        font-weight: 600;
                    }
                    .notes-list {
                        list-style: none;
                        display: grid;
                        gap: 12px;
                    }
                    .notes-list li {
                        background: linear-gradient(180deg, #f0f8fb 0%, #fef7fb 100%);
                        border-radius: 10px;
                        border: 1px solid #f5fafe;
                        box-shadow: 0 2px 8px rgba(224, 231, 255, 0.5);
                        transition: all 0.3s ease;
                    }
                    .notes-list li:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(224, 231, 255, 0.8);
                    }
                    .notes-list a {
                        display: flex;
                        align-items: center;
                        padding: 16px 20px;
                        color: #2d3748;
                        text-decoration: none;
                        font-size: 16px;
                    }
                    /* å…³é”®ä¿®å¤3ï¼šç¬”è®°å‰ç¼€æ”¹ç”¨HTMLå®ä½“ï¼Œæ›¿æ¢åŸç”ŸEmoji */
                    .notes-list a::before {
                        content: '\1F4D5'; /* æ›¿æ¢ &#128213;ï¼ŒCSSè¯†åˆ«çš„Unicodeè½¬ä¹‰åºåˆ—ï¼Œå¯¹åº”ğŸ“šè¡¨æƒ… */
                        margin-right: 12px;
                        font-size: 18px;
                    }
                    .notes-list a:hover {
                        color: #4299e1;
                    }
                    .back-btn {
                        margin-top: 30px;
                        text-align: center;
                    }
                    .back-btn a {
                        display: inline-block;
                        padding: 10px 24px;
                        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        text-decoration: none;
                        border-radius: 8px;
                        font-size: 15px;
                        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                    }
                    .back-btn a:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                    }
                    .footer {
                        text-align: center;
                        margin-top: 25px;
                        background: linear-gradient(90deg, #718096, #a0aec0);
                        -webkit-background-clip: text;
                        background-clip: text;
                        color: transparent;
                        font-size: 14px;
                        padding-bottom: 10px;
                    }
                    @media (max-width: 768px) {
                        body {
                            max-width: 100%;
                            padding: 15px;
                        }
                        .container {
                            padding: 30px 20px;
                        }
                        .avatar {
                            width: 100px;
                            height: 100px;
                            font-size: 40px;
                        }
                        h1 {
                            font-size: 28px;
                        }
                        .notes-section h2 {
                            font-size: 20px;
                        }
                        .notes-list a {
                            padding: 14px 16px;
                            font-size: 15px;
                        }
                    }
                </style>
            </head>
            <body>
                <div class='container'>
                    <div class='header'>
                        <div class='avatar'>$AVATAR_CONTENT</div> <!-- ä½¿ç”¨HTMLå®ä½“æ›¿ä»£åŸç”ŸEmoji -->
                        <h1>$PAGE_TITLE</h1>
                        <p class='subtitle'>$SUB_TITLE</p>
                    </div>
                    <div class='notes-section'>
                        <h2>æˆ‘çš„ç¬”è®°åˆ—è¡¨</h2>
                        <ul class='notes-list'>" >> notes.html
            
            # å®¹é”™éå†ï¼Œç¡®ä¿æ•è·æ‰€æœ‰HTMLæ–‡ä»¶ï¼ˆåŒ…æ‹¬æ–°å¢çš„a.htmlï¼‰
            shopt -s nullglob
            # æ˜¾å¼åˆ—å‡ºæ‰€æœ‰HTMLæ–‡ä»¶ï¼Œä¾¿äºæ—¥å¿—æ’æŸ¥
            echo "å½“å‰ç›®å½• $dir ä¸‹çš„HTMLæ–‡ä»¶ï¼š"
            ls -la *.html || echo "æ— HTMLæ–‡ä»¶"
            for file in *.html; do
              if [ "$file" != "notes.html" ]; then
                title=$(echo "$file" | sed 's/\.html//g; s/-/ /g; s/_/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)} 1')
                echo "æ·»åŠ æ–‡ä»¶é“¾æ¥ï¼š$file -> $title"
                echo "                            <li><a href='$file'>$title</a></li>" >> notes.html
              fi
            done
            shopt -u nullglob
            
            # è¡¥å……HTMLå°¾éƒ¨å†…å®¹
            echo "                        </ul>
                    </div>
                    <div class='back-btn'>
                        <a href='../index.html'>â† è¿”å›ä¸ªäººä¸»é¡µ</a>
                    </div>
                </div>
                <div class='footer'>
                    <p>ä¸€ä¸ªçˆ±æ€è€ƒã€çˆ±è¾ƒçœŸã€çˆ±ç¡è§‰çš„æ™®é€šäºº Â© 2025</p>
                </div>
            </body>
            </html>" >> notes.html
            
            cd ..
          done
      
      - name: æäº¤å¹¶æ¨é€æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
        run: |
          # é…ç½®Gitèº«ä»½
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # å…ˆæš‚å­˜æ‰€æœ‰æœ¬åœ°å˜æ›´ï¼ˆè§£å†³æœªæš‚å­˜å˜æ›´æŠ¥é”™ï¼‰
          find . -maxdepth 2 -name "notes.html" | grep -vE "\.github|\.git|node_modules|assets|images" | xargs git add 2>/dev/null
          
          # å…ˆæäº¤æœ¬åœ°å˜æ›´ï¼ˆè‹¥æœ‰ï¼‰ï¼Œå†æ‹‰å–è¿œç¨‹ä»£ç 
          git commit -m "ä¸´æ—¶æäº¤æœ¬åœ°ç”Ÿæˆçš„notes.html" || echo "æ— æœ¬åœ°å˜æ›´éœ€æå‰æäº¤"
          
          # æ‹‰å–è¿œç¨‹æœ€æ–°ä»£ç ï¼ˆæ­¤æ—¶æœ¬åœ°å·²æ— æœªæš‚å­˜å˜æ›´ï¼Œå¯å®‰å…¨rebaseï¼‰
          git pull origin main --rebase || (git rebase --abort && echo "rebaseå†²çªï¼Œæ”¾å¼ƒæ‹‰å–è¿œç¨‹ä»£ç ")
          
          # å†æ¬¡æ·»åŠ å¹¶æäº¤ï¼ˆç¡®ä¿rebaseåå˜æ›´ä»è¢«æ•è·ï¼‰
          find . -maxdepth 2 -name "notes.html" | grep -vE "\.github|\.git|node_modules|assets|images" | xargs git add 2>/dev/null
          git status
          git commit -m "è‡ªåŠ¨æ›´æ–°æ‰€æœ‰å­ç›®å½•ç¬”è®°åˆ—è¡¨ï¼ˆåŒ…å«æ–°å¢æ–‡ä»¶ï¼Œä¿®å¤Emojiä¹±ç ï¼‰ï¼š$(date +%Y-%m-%d\ %H:%M:%S)" || echo "æ— æ–‡ä»¶éœ€è¦æäº¤"
          
          # æ¨é€å˜æ›´
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
