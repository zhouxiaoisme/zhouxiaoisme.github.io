name: 自动生成所有子目录笔记列表
on:
  push:
    paths:
      - '**/*.html'  # 监听所有HTML文件（包括新增/修改/删除）
      - '.github/workflows/generate-notes.yml' # 配置文件变更也触发
  workflow_dispatch:  # 手动触发兜底
jobs:
  generate-notes:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 自动扫描并生成所有子目录笔记列表
        run: |
          # 定义需要排除的目录
          EXCLUDE_DIRS=(".github" "node_modules" "assets" "images" ".git")
          
          # 获取根目录下所有一级子目录
          ALL_DIRS=$(find . -maxdepth 1 -type d | sed 's|^\./||' | grep -v '^\.$')
          
          # 遍历每个目录
          for dir in $ALL_DIRS; do
            # 跳过排除目录
            if [[ " ${EXCLUDE_DIRS[@]} " =~ " $dir " ]]; then
              echo "跳过排除目录：$dir"
              continue
            fi
            
            echo "开始处理目录：$dir"
            # 目录无法进入则跳过
            cd "$dir" || continue
            
            # 生成个性化标题
            DIR_NAME_CLEAN=$(echo "$dir" | sed 's/Course//g')
            DIR_TITLE=$(echo "$DIR_NAME_CLEAN" | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)} 1')
            PAGE_TITLE="${DIR_TITLE}学习笔记"
            SUB_TITLE="从底层逻辑拆解${PAGE_TITLE}，较真每一个知识点"
            
            # 个性化图标
            case $DIR_NAME_CLEAN in
              "python") AVATAR_EMOJI="??" ;;
              "ai") AVATAR_EMOJI="??" ;;
              "aigc") AVATAR_EMOJI="??" ;;
              "java") AVATAR_EMOJI="?" ;;
              "web") AVATAR_EMOJI="??" ;;
              *) AVATAR_EMOJI="??" ;;
            esac

            # 强制清空旧的notes.html，确保完全重新生成
            rm -f notes.html
            # 重新创建空的notes.html
            touch notes.html
            
            # 写入HTML头部
            echo "<!DOCTYPE html>
            <html lang='zh-CN'>
            <head>
                <meta charset='UTF-8'>
                <meta name='viewport' content='width=device-width, initial-scale=1.0'>
                <title>$PAGE_TITLE | 一个普通的思考者</title>
                <style>
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                        font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
                        transition: all 0.3s ease;
                    }
                    body {
                        background: linear-gradient(120deg, #f5f7fa 0%, #e4eaf5 100%);
                        color: #333;
                        line-height: 1.5;
                        padding: 20px;
                        max-width: 1000px;
                        margin: 0 auto;
                        min-height: 100vh;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                    }
                    .container {
                        background: rgba(255, 255, 255, 0.95);
                        border-radius: 16px;
                        padding: 40px 60px;
                        box-shadow: 0 8px 24px rgba(149, 157, 165, 0.15);
                        border: 1px solid #e8f4f8;
                    }
                    .header {
                        text-align: center;
                        margin-bottom: 35px;
                    }
                    .avatar {
                        width: 120px;
                        height: 120px;
                        border-radius: 50%;
                        background: linear-gradient(45deg, #4299e1 0%, #38b2ac 100%);
                        margin: 0 auto 20px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 48px;
                        color: white;
                        box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
                    }
                    .avatar:hover {
                        transform: scale(1.05);
                        box-shadow: 0 6px 18px rgba(66, 153, 225, 0.4);
                    }
                    h1 {
                        font-size: 32px;
                        margin-bottom: 8px;
                        background: linear-gradient(90deg, #2d3748, #4a5568);
                        -webkit-background-clip: text;
                        background-clip: text;
                        color: transparent;
                        font-weight: 600;
                    }
                    .subtitle {
                        color: #718096;
                        font-size: 17px;
                        font-weight: 400;
                        font-style: italic;
                    }
                    .notes-section h2 {
                        font-size: 22px;
                        margin-bottom: 15px;
                        background: linear-gradient(90deg, #4299e1, #9f7aea);
                        -webkit-background-clip: text;
                        background-clip: text;
                        color: transparent;
                        border-left: 4px solid #4299e1;
                        padding-left: 12px;
                        font-weight: 600;
                    }
                    .notes-list {
                        list-style: none;
                        display: grid;
                        gap: 12px;
                    }
                    .notes-list li {
                        background: linear-gradient(180deg, #f0f8fb 0%, #fef7fb 100%);
                        border-radius: 10px;
                        border: 1px solid #f5fafe;
                        box-shadow: 0 2px 8px rgba(224, 231, 255, 0.5);
                        transition: all 0.3s ease;
                    }
                    .notes-list li:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(224, 231, 255, 0.8);
                    }
                    .notes-list a {
                        display: flex;
                        align-items: center;
                        padding: 16px 20px;
                        color: #2d3748;
                        text-decoration: none;
                        font-size: 16px;
                    }
                    .notes-list a::before {
                        content: '??';
                        margin-right: 12px;
                        font-size: 18px;
                    }
                    .notes-list a:hover {
                        color: #4299e1;
                    }
                    .back-btn {
                        margin-top: 30px;
                        text-align: center;
                    }
                    .back-btn a {
                        display: inline-block;
                        padding: 10px 24px;
                        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        text-decoration: none;
                        border-radius: 8px;
                        font-size: 15px;
                        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                    }
                    .back-btn a:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                    }
                    .footer {
                        text-align: center;
                        margin-top: 25px;
                        background: linear-gradient(90deg, #718096, #a0aec0);
                        -webkit-background-clip: text;
                        background-clip: text;
                        color: transparent;
                        font-size: 14px;
                        padding-bottom: 10px;
                    }
                    @media (max-width: 768px) {
                        body {
                            max-width: 100%;
                            padding: 15px;
                        }
                        .container {
                            padding: 30px 20px;
                        }
                        .avatar {
                            width: 100px;
                            height: 100px;
                            font-size: 40px;
                        }
                        h1 {
                            font-size: 28px;
                        }
                        .notes-section h2 {
                            font-size: 20px;
                        }
                        .notes-list a {
                            padding: 14px 16px;
                            font-size: 15px;
                        }
                    }
                </style>
            </head>
            <body>
                <div class='container'>
                    <div class='header'>
                        <div class='avatar'>$AVATAR_EMOJI</div>
                        <h1>$PAGE_TITLE</h1>
                        <p class='subtitle'>$SUB_TITLE</p>
                    </div>
                    <div class='notes-section'>
                        <h2>我的笔记列表</h2>
                        <ul class='notes-list'>" >> notes.html
            
            # 容错遍历，确保捕获所有HTML文件（包括新增的a.html）
            shopt -s nullglob
            # 显式列出所有HTML文件，便于日志排查
            echo "当前目录 $dir 下的HTML文件："
            ls -la *.html || echo "无HTML文件"
            for file in *.html; do
              if [ "$file" != "notes.html" ]; then
                title=$(echo "$file" | sed 's/\.html//g; s/-/ /g; s/_/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)} 1')
                echo "添加文件链接：$file -> $title"
                echo "                            <li><a href='$file'>$title</a></li>" >> notes.html
              fi
            done
            shopt -u nullglob
            
            # 写入HTML尾部
            echo "                        </ul>
                    </div>
                    <div class='back-btn'>
                        <a href='../index.html'>← 返回个人主页</a>
                    </div>
                </div>
                <div class='footer'>
                    <p>一个爱思考、爱较真、爱睡觉的普通人 ? 2025</p>
                </div>
            </body>
            </html>" >> notes.html
            
            cd ..
          done
      
      - name: 提交并推送所有生成的文件
        run: |
          # 配置Git身份
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # 关键修复1：先暂存所有本地变更（解决未暂存变更报错）
          find . -maxdepth 2 -name "notes.html" | grep -vE "\.github|\.git|node_modules|assets|images" | xargs git add 2>/dev/null
          
          # 关键修复2：先提交本地变更（若有），再拉取远程代码
          git commit -m "临时提交本地生成的notes.html" || echo "无本地变更需提前提交"
          
          # 关键修复3：拉取远程最新代码（此时本地已无未暂存变更，可安全rebase）
          git pull origin main --rebase || (git rebase --abort && echo "rebase冲突，放弃拉取远程代码")
          
          # 关键修复4：再次添加并提交（确保rebase后变更仍被捕获）
          find . -maxdepth 2 -name "notes.html" | grep -vE "\.github|\.git|node_modules|assets|images" | xargs git add 2>/dev/null
          git status
          git commit -m "自动更新所有子目录笔记列表（包含新增文件）：$(date +%Y-%m-%d\ %H:%M:%S)" || echo "无文件需要提交"
          
          # 推送变更
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
